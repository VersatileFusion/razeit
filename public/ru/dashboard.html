<!doctype html>
<html class="no-js " lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Razeit - Панель управления</title>
    <meta name="author" content="Razeit">
    <meta name="description" content="Razeit - Esports & Gaming Platform">
    <meta name="keywords" content="Razeit - Esports & Gaming Platform">
    <meta name="robots" content="INDEX,FOLLOW">

    <!-- Mobile Specific Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="57x57" href="../assets/img/favicons/apple-icon-57x57.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/img/favicons/favicon-32x32.png">
    <link rel="manifest" href="../assets/img/favicons/manifest.json">

    <!--==============================
	  Google Fonts
	============================== -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!--==============================
	    All CSS File
	============================== -->
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/fontawesome.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">

    <style>
        body {
            background: #0a0a0a;
            color: #ffffff;
        }

        .dashboard-wrapper {
            min-height: 100vh;
            padding: 100px 0 50px;
        }

        /* Header Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(69, 248, 130, 0.1) 0%, rgba(15, 15, 15, 0.95) 100%);
            border: 2px solid #45F882;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(69, 248, 130, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(69, 248, 130, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: rgba(69, 248, 130, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .stat-icon i {
            font-size: 28px;
            color: #45F882;
        }

        .stat-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            color: #a0a0a0;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Goldman', sans-serif;
            font-size: 32px;
            font-weight: 700;
            color: #45F882;
            text-shadow: 0 0 15px rgba(69, 248, 130, 0.5);
        }

        .stat-change {
            font-size: 12px;
            color: #45F882;
            margin-top: 5px;
        }

        .stat-change.negative {
            color: #ff4444;
        }

        /* Section Styles */
        .dashboard-section {
            background: rgba(15, 15, 15, 0.95);
            border: 2px solid #45F882;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 40px rgba(69, 248, 130, 0.2);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(69, 248, 130, 0.3);
        }

        .section-title {
            font-family: 'Goldman', sans-serif;
            font-size: 24px;
            font-weight: 700;
            color: #45F882;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(69, 248, 130, 0.3);
        }

        .section-link {
            color: #a0a0a0;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .section-link:hover {
            color: #45F882;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .action-btn {
            padding: 20px;
            background: linear-gradient(135deg, rgba(69, 248, 130, 0.1) 0%, rgba(30, 30, 30, 0.8) 100%);
            border: 2px solid rgba(69, 248, 130, 0.3);
            border-radius: 12px;
            color: #ffffff;
            text-decoration: none;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .action-btn:hover {
            border-color: #45F882;
            background: linear-gradient(135deg, rgba(69, 248, 130, 0.2) 0%, rgba(30, 30, 30, 0.9) 100%);
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(69, 248, 130, 0.3);
        }

        .action-btn i {
            font-size: 32px;
            color: #45F882;
        }

        .action-btn span {
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 16px;
            text-transform: uppercase;
        }

        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .item-card {
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid rgba(69, 248, 130, 0.2);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            border-color: #45F882;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(69, 248, 130, 0.2);
        }

        .item-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(135deg, rgba(69, 248, 130, 0.1) 0%, rgba(0, 0, 0, 0.8) 100%);
        }

        .item-content {
            padding: 15px;
        }

        .item-title {
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .item-price {
            font-family: 'Goldman', sans-serif;
            font-size: 20px;
            color: #45F882;
            margin-bottom: 10px;
        }

        .item-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #a0a0a0;
        }

        .item-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active { background: rgba(69, 248, 130, 0.2); color: #45F882; }
        .status-sold { background: rgba(255, 68, 68, 0.2); color: #ff4444; }
        .status-pending { background: rgba(255, 170, 0, 0.2); color: #ffaa00; }

        /* Activity Feed */
        .activity-feed {
            max-height: 500px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(30, 30, 30, 0.5);
            border-left: 3px solid #45F882;
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: rgba(69, 248, 130, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon i {
            color: #45F882;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: #ffffff;
            margin-bottom: 4px;
        }

        .activity-time {
            font-size: 12px;
            color: #a0a0a0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #a0a0a0;
        }

        .empty-state i {
            font-size: 64px;
            color: rgba(69, 248, 130, 0.3);
            margin-bottom: 20px;
        }

        /* Loading */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #loadingOverlay.active {
            display: flex;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(69, 248, 130, 0.2);
            border-top-color: #45F882;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Back Button */
        .back-to-home {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 1000;
        }

        .back-to-home a {
            display: inline-flex;
            align-items: center;
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            text-decoration: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .back-to-home a:hover {
            background: rgba(69, 248, 130, 0.2);
            border-color: #45F882;
        }

        .back-to-home i {
            margin-right: 8px;
        }
    </style>

</head>

<body>
    <div class="cursor-animation cursor-image"></div>

    <div class="back-to-home">
        <a href="index.html">
            <i class="fas fa-arrow-left"></i>
            Главная
        </a>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <div class="dashboard-wrapper">
        <div class="container">
            <!-- User Welcome Header -->
            <div class="dashboard-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 style="font-family: 'Goldman', sans-serif; font-size: 42px; color: #45F882; text-shadow: 0 0 20px rgba(69, 248, 130, 0.5); margin-bottom: 10px;">
                            С возвращением, <span id="userName">Геймер</span>!
                        </h1>
                        <p style="color: #a0a0a0; font-size: 16px;">Вот что происходит с вашей учетной записью сегодня.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="profile.html" class="action-btn" style="display: inline-flex; padding: 15px 30px;">
                            <i class="fas fa-user-circle"></i>
                            <span>Просмотр профиля</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-gem"></i>
                    </div>
                    <div class="stat-label">Всего гемов</div>
                    <div class="stat-value" id="totalGems">0</div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i> Доступно для траты
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="stat-label">Баланс кошелька</div>
                    <div class="stat-value" id="walletBalance">$0</div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i> USD
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-shopping-bag"></i>
                    </div>
                    <div class="stat-label">Предметов выставлено</div>
                    <div class="stat-value" id="itemsListed">0</div>
                    <div class="stat-change" id="itemsChange">
                        <i class="fas fa-minus"></i> Без изменений
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-label">Общий заработок</div>
                    <div class="stat-value" id="totalEarnings">$0</div>
                    <div class="stat-change">
                        <i class="fas fa-arrow-up"></i> За все время
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Быстрые действия</h2>
                </div>
                <div class="quick-actions">
                    <a href="#" class="action-btn" id="sellItemBtn">
                        <i class="fas fa-plus-circle"></i>
                        <span>Продать предмет</span>
                    </a>
                    <a href="#" class="action-btn" id="buyGemsBtn">
                        <i class="fas fa-gem"></i>
                        <span>Купить гемы</span>
                    </a>
                    <a href="#" class="action-btn" id="spinWheelBtn">
                        <i class="fas fa-spinner"></i>
                        <span>Крутить колесо</span>
                    </a>
                    <a href="#" class="action-btn" id="browseMarketBtn">
                        <i class="fas fa-store"></i>
                        <span>Обзор маркета</span>
                    </a>
                    <a href="#" class="action-btn" id="servicesBtn">
                        <i class="fas fa-briefcase"></i>
                        <span>Услуги</span>
                    </a>
                    <a href="#" class="action-btn" id="steamBtn">
                        <i class="fab fa-steam"></i>
                        <span>Подключить Steam</span>
                    </a>
                </div>
            </div>

            <div class="row">
                <!-- My Marketplace Items -->
                <div class="col-lg-8">
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2 class="section-title">Мои предметы</h2>
                            <a href="#" class="section-link">Посмотреть все →</a>
                        </div>
                        <div class="items-grid" id="myItems">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <p>Предметы еще не выставлены</p>
                            </div>
                        </div>
                    </div>

                    <!-- My Services -->
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2 class="section-title">Мои услуги</h2>
                            <a href="#" class="section-link">Посмотреть все →</a>
                        </div>
                        <div class="items-grid" id="myServices">
                            <div class="empty-state">
                                <i class="fas fa-briefcase"></i>
                                <p>Услуги еще не созданы</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-lg-4">
                    <div class="dashboard-section">
                        <div class="section-header">
                            <h2 class="section-title">Недавняя активность</h2>
                        </div>
                        <div class="activity-feed" id="activityFeed">
                            <div class="empty-state">
                                <i class="fas fa-history"></i>
                                <p>Нет недавней активности</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Purchases -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2 class="section-title">Недавние покупки</h2>
                    <a href="#" class="section-link">Посмотреть все →</a>
                </div>
                <div class="items-grid" id="recentPurchases">
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Покупок пока нет</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--==============================
        All Js File
    ============================== -->
    <script src="../assets/js/vendor/jquery-3.7.1.min.js"></script>
    <script src="../assets/js/bootstrap.min.js"></script>

    <script>
        // Configuration
        const API_URL = 'http://localhost:5000/api';
        
        console.log('🎮 Razeit Dashboard Loaded');
        console.log('📡 API URL:', API_URL);

        // State
        let currentUser = null;
        let dashboardData = null;

        // Helper functions
        function setLoading(isLoading) {
            document.getElementById('loadingOverlay').classList.toggle('active', isLoading);
        }

        function checkAuth() {
            console.log('🔐 Checking authentication...');
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                console.log('❌ No auth token found');
                alert('Please sign in to view dashboard');
                setTimeout(() => {
                    window.location.href = 'signin.html';
                }, 1000);
                return false;
            }
            
            console.log('✅ Auth token found');
            return token;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-US').format(num || 0);
        }

        function formatPrice(price) {
            return `$${formatNumber(price)}`;
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + ' years ago';
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + ' months ago';
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + ' days ago';
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + ' hours ago';
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + ' minutes ago';
            
            return Math.floor(seconds) + ' seconds ago';
        }

        // Load Dashboard Data
        async function loadDashboard() {
            console.log('📥 Loading dashboard data...');
            const token = checkAuth();
            if (!token) return;

            setLoading(true);

            try {
                console.log('🌐 Fetching user data...');
                
                // Get user profile
                const userResponse = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!userResponse.ok) {
                    throw new Error('Failed to fetch user data');
                }

                const userData = await userResponse.json();
                currentUser = userData.user;
                console.log('✅ User data loaded:', currentUser);

                // Get dashboard data
                const dashboardResponse = await fetch(`${API_URL}/users/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!dashboardResponse.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }

                const dashboard = await dashboardResponse.json();
                dashboardData = dashboard.dashboard;
                console.log('✅ Dashboard data loaded:', dashboardData);

                // Display all data
                displayUserInfo();
                displayStats();
                displayMarketplaceItems();
                displayServices();
                displayPurchases();
                displayActivity();

            } catch (error) {
                console.error('💥 Error loading dashboard:', error);
                
                if (error.message.includes('401')) {
                    alert('Session expired. Please sign in again.');
                    localStorage.removeItem('authToken');
                    window.location.href = 'signin.html';
                } else {
                    alert('Failed to load dashboard. Please try again.');
                }
            } finally {
                setLoading(false);
            }
        }

        // Display Functions
        function displayUserInfo() {
            document.getElementById('userName').textContent = currentUser.firstName || 'Gamer';
        }

        function displayStats() {
            const stats = dashboardData.stats;
            
            document.getElementById('totalGems').textContent = formatNumber(stats.gems || 0);
            document.getElementById('walletBalance').textContent = formatPrice(stats.walletBalance || 0);
            document.getElementById('itemsListed').textContent = formatNumber(stats.totalItemsSold || 0);
            document.getElementById('totalEarnings').textContent = formatPrice(stats.totalEarnings || 0);
        }

        function displayMarketplaceItems() {
            const container = document.getElementById('myItems');
            const items = dashboardData.recentMarketplaceItems || [];

            if (items.length === 0) {
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="item-card">
                    <img src="${item.images && item.images[0] ? item.images[0].url : '../assets/img/product/product_thumb_1_1.png'}" 
                         alt="${item.title}" class="item-image">
                    <div class="item-content">
                        <div class="item-title">${item.title}</div>
                        <div class="item-price">${item.price.gems} <i class="fas fa-gem"></i></div>
                        <div class="item-meta">
                            <span class="item-status status-${item.status}">${item.status}</span>
                            <span>${item.views || 0} views</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayServices() {
            const container = document.getElementById('myServices');
            const services = dashboardData.recentServices || [];

            if (services.length === 0) {
                return;
            }

            container.innerHTML = services.map(service => `
                <div class="item-card">
                    <img src="${service.images && service.images[0] ? service.images[0].url : '../assets/img/game/logo2-1.png'}" 
                         alt="${service.title}" class="item-image">
                    <div class="item-content">
                        <div class="item-title">${service.title}</div>
                        <div class="item-price">${service.price.gems} <i class="fas fa-gem"></i></div>
                        <div class="item-meta">
                            <span>⭐ ${service.rating?.average || 0}</span>
                            <span>${service.orders?.length || 0} orders</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayPurchases() {
            const container = document.getElementById('recentPurchases');
            const purchases = dashboardData.recentPurchases || [];

            if (purchases.length === 0) {
                return;
            }

            container.innerHTML = purchases.map(item => `
                <div class="item-card">
                    <img src="${item.images && item.images[0] ? item.images[0].url : '../assets/img/product/product_thumb_1_1.png'}" 
                         alt="${item.title}" class="item-image">
                    <div class="item-content">
                        <div class="item-title">${item.title}</div>
                        <div class="item-price">${item.price.gems} <i class="fas fa-gem"></i></div>
                        <div class="item-meta">
                            <span>Purchased</span>
                            <span>${timeAgo(item.soldAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function displayActivity() {
            const container = document.getElementById('activityFeed');
            
            // Generate activity from dashboard data
            const activities = [];
            
            // Recent items
            (dashboardData.recentMarketplaceItems || []).slice(0, 3).forEach(item => {
                activities.push({
                    icon: 'fa-plus',
                    text: `Listed "${item.title}" for ${item.price.gems} gems`,
                    time: item.createdAt
                });
            });

            // Recent purchases
            (dashboardData.recentPurchases || []).slice(0, 2).forEach(item => {
                activities.push({
                    icon: 'fa-shopping-cart',
                    text: `Purchased "${item.title}"`,
                    time: item.soldAt
                });
            });

            if (activities.length === 0) {
                return;
            }

            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            container.innerHTML = activities.map(activity => `
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas ${activity.icon}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-text">${activity.text}</div>
                        <div class="activity-time">${timeAgo(activity.time)}</div>
                    </div>
                </div>
            `).join('');
        }

        // Initialize
        loadDashboard();

        // Quick action handlers
        document.getElementById('sellItemBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Sell Item feature coming soon!');
        });

        document.getElementById('buyGemsBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Buy Gems feature coming soon!');
        });

        document.getElementById('spinWheelBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Spin Wheel feature coming soon!');
        });

        document.getElementById('browseMarketBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Browse Market feature coming soon!');
        });

        document.getElementById('servicesBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Services feature coming soon!');
        });

        document.getElementById('steamBtn').addEventListener('click', (e) => {
            e.preventDefault();
            alert('Steam Connect feature coming soon!');
        });

        console.log('✅ Dashboard initialized');
    </script>

</body>

</html>
